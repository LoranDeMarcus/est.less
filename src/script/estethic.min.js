function InitChooseMaster(){function e(){var e=$("form[name=master]"),t=!0;e.length?e.each(function(){if(!$(this).find(".master.active").length)return t=!1,!1}):t=!1,t?$("#choose-master-submit").attr("disabled",!1).parent().tooltip("destroy"):$("#choose-master-submit").attr("disabled",!0).parent().tooltip()}$('[data-toggle="tooltip"]').tooltip(),$(document).on("click","#services-nav a",function(){return $(this).tab("show"),!1}),$(document).on("click",".master-types label",function(e){serviceId=$(this).attr("id"),console.log(serviceId),parentId=$(".master-types label #"+serviceId).parent().attr("id"),$(".master-types label #"+serviceId).hasClass("any")&&serviceId==parentId?($(this).removeClass("active"),$(this).siblings("label #"+serviceId).removeClass("active")):$(this).siblings("label.any").removeClass("active"),setTimeout(function(){var e=$(".master-types label.active");console.log(e),$(".master-types label.active").hasClass("any")?$("."+serviceId+" .masters-list .master").removeClass("hidden"):($(".master-types label .any").removeClass("hidden"),$("."+serviceId+" .masters-list .master").addClass("hidden"),e.each(function(){var e=$(this).data("class");console.log("activating class "+e),$("."+serviceId+' .masters-list .master[data-class="'+e+'"]').removeClass("hidden")}))},10),console.log("test service id now: "+serviceId)}),$(document).on("click",".master > a",function(){if(!$(this).hasClass("master-vacation")){var t=$(this).parents(".master");return t.toggleClass("active").find("input[type=checkbox]").attr("checked",t.hasClass("active")),e(),!1}}),$(document).on("click","#select-all-btn",function(){$(this).parents("form").find("a.media").addClass("active"),e()}),$("#choose-master-submit").on("click",function(){var e=$(this);$(".masters-list .master.hidden input[type=checkbox]").attr("checked",null);var t=$(".choose-concrete-master:not(.hidden) form[name=master]").serialize();return e.attr("disabled",!0),$.post(e.data("submit"),t,function(){window.location=e.attr("href")}),!1}),$(document).on("click",".add-service-btn",function(){$("#add-service-panel").show(),$("#services-block, .controls").hide()}),e()}
function InitRecordConfirm(){window.location.hash.split("#")[1];$(".btn-confirm-record").on("click",function(){$(this).addClass("active"),$(".btn-confirm-registration").removeClass("active"),$(".btn-confirm-cabinet").removeClass("active"),$(".confirm-registration").hide(),$(".confirm-cabinet").hide(),$(".confirm-record").show()}),$(".btn-confirm-registration").on("click",function(){$(this).addClass("active"),$(".btn-confirm-record").removeClass("active"),$(".btn-confirm-cabinet").removeClass("active"),$(".confirm-registration").show(),$(".confirm-cabinet").hide(),$(".confirm-record").hide()}),$(".btn-confirm-cabinet").on("click",function(){$(this).addClass("active"),$(".btn-confirm-record").removeClass("active"),$(".btn-confirm-registration").removeClass("active"),$(".confirm-registration").hide(),$(".confirm-cabinet").show(),$(".confirm-record").hide()}),$(document).ready(function(){$(".auth-toggle").click(function(){var i=$(this),t=i.text().trim();return i.text(i.data("alt-text")).data("alt-text",t),$(".auth").toggleClass("hidden"),!1})}),$("#review-logged-in-confirm").click(function(){$.post("/ajax/set_utail_user",{utail_user_id:$("input[name=utail-user-id]").val()},function(i){window.location.href="/record/confirm"})})}
function InitCabinet(){function t(){var t=i.serialize();return t+="&sort_by="+i.find("button[name=sort_by].active").val()}function a(t,a){var e=$(".history-data"),n=(i.find("select[name=direction]"),e.hasClass("empty"));t.count>0?(n&&(e.after('<ul class="history-data">'),e.remove(),e=$(".history-data")),a?e.empty():e.find("li.next").remove(),e.append(t.view)):n||(e.after('<div class="history-data empty">???µN‚ ?·?°????N??µ??</div>'),e.remove(),e=$(".history-data"))}function e(){App.ajaxCall("get_records_history",t(),function(t){console.log(t),a(t,!0)})}$(".record-cancel").tooltip(),$("#notifications-form input").change(function(){$("#notifications-form").submit()}),$("#notifications-form").submit(function(){return App.ajaxCall("update_notifications_settings",$(this).serialize()),$("#notifications").tooltip("show"),!1});var i=$("#record-filter");i.find("select[name=range]").change(e),i.find("button[name=sort_by]").click(function(){var t=i.find("button[name=sort_by]"),a=$(this);a.hasClass("active")||(t.removeClass("active").filter(this).addClass("active"),e())}),i.find("select[name=direction]").change(function(){var t=$(".history-data"),a=$(this).val();"all"===a?t.children().removeClass("hidden"):t.children().addClass("hidden").filter("*[data-direction-id="+a+"]").removeClass("hidden")}),$(document).on("click",".history-data .next > a",function(){var e=$(this),i=e.data("offset"),n=t();return n+="&offset="+i,App.ajaxCall("get_records_history",n,function(t){a(t,!1)}),!1}),e(),$(".save-contacts").on("click",function(){var t=$("input[name=client_email]").val(),a=$("input[name=client_phone]").val();a="8"+a,App.ajaxCall("update_user_information",{email:t,phone:a},function(t){1==t.response?($(".save-contacts").removeClass("btn-primary").addClass("btn-success").addClass("disabled").text("????N…Nˆ?°???µ????"),setTimeout(function(){$(".save-contacts").removeClass("btn-success").removeClass("disabled").addClass("btn-primary").text("????N…Nˆ?°????N‚N?")},3e3)):(alert("?zN????±???° ???·???µ???µ????N? ??????N‚?°??N‚??N‹N… ???°????N…. ?’???·?????¶???? ???»???µ??N‚ N? ?????µ???µ??N‹???? ???°????N‹???? N?N?N‰?µN?N‚??N??µN‚!"),console.log(t))})})}
function InitChooseService(){function e(e){for(var t in d)if(d[t].id==e)return d[t];return null}function t(e){for(var t in v)if(v[t].id==e)return v[t];return null}function s(){return $("#services-chosen li").map(function(){return $(this).data("id")}).get()}function r(s,r){var i=e(s);if(!i)return!1;i.selected=r,$("#services option[value="+s+"]").attr({selected:!1,disabled:r});var o=t(i.group_id),c=$("#services-groups option[value="+i.group_id+"]");return r?0===$("#services option").not(":disabled").size()&&(c.attr("disabled",!0),o.disabled=!0):(c.attr("disabled",!1),o.disabled=!1,$("#services-distincts option[value="+o.parent_id+"]").attr("disabled",null)),!0}function i(e,t){return $("#services-chosen").show().children("ul:first").append($('<li data-id="'+e+'" class="list-group-item selected-service">').append('<h4 class="service-title">'+t+'</h4><button class="remove-service-btn label label-danger remove-label" data-service-id="">N????°?»??N‚N?</button>')),$("a").data("service-id",e).parent().tooltip(),$("#choose-services-submit").tooltip("show"),c(),!0}function o(e){return $("#services-chosen li[data-id="+e+"]").remove(),$("#services-chosen li").length||$("#services-chosen").hide(),!0}function c(){var e=s();$("#service-form-block").toggle(e.length<$("#services-chosen").data("limit")),$("#add-service-form button[type=submit]").attr("disabled",!$("#services").val()),e.length?($("#services-chosen").show(),$("#choose-services-submit").attr("disabled",null).parent().tooltip("destroy")):($("#services-chosen").hide(),$("#services").val()?$("#choose-services-submit").attr("disabled",null).parent().tooltip("destroy"):$("#choose-services-submit").attr("disabled",!0).parent().tooltip())}function n(e){return App.ajaxCall("get_recommendations_for_service",{service_id:e},function(t){if(0!==t.response)return!1;if(!t.hasOwnProperty("recommendations_for_service")||0===t.recommendations_for_service.length)return!1;var s=t.recommendations_for_service,r="";s.forEach(function(e){r+='<li class="recommend-service-item" data-service-id="'+e.service_id+'"><div href="#" class="btn-link color-gold recommend-service"><span class="glyphicon glyphicon-plus"></span> '+e.title+"</div></li>"});var i='<ul class="list-unstyled popover-recommendations">'+r+"</ul>",o=$('.selected-service[data-id="'+e+'"]');o.popover("destroy"),$("#choose-services-submit").tooltip("hide"),o.popover({title:"? ?µ???????µ????N??µ?? ?????µN?N‚?µ N? N?N‚???? N?N??»N???????",placement:"top",html:!0,content:i}),o.popover("show")}),!1}$("#services-groups").prop("disabled",!0).selectpicker("refresh"),$("#services").prop("disabled",!0).selectpicker("refresh");var a={},d=$("#services option").map(function(){var e=$(this);return a[e.data("group-id")]=!0,{id:parseInt(e.val()),group_id:parseInt(e.data("group-id")),title:e.text(),selected:!!e.attr("disabled")}}).get();$("#services-groups option").each(function(){var e=$(this).val();void 0===a[e]&&$(this).remove()});var l={},v=$("#services-groups option").map(function(){var e=$(this),t=$.grep(d,function(t){return t.group_id==parseInt(e.val())&&!t.selected});return l[e.data("parent-id")]=!0,{id:parseInt(e.val()),parent_id:parseInt(e.data("parent-id")),title:e.text(),disabled:!t.length}}).get();$("#services-distincts option").each(function(){var e=$(this).val();e&&void 0===l[e]&&$(this).remove()}),$("#services-distincts").on("changed.bs.select",function(e){var t=$(this).selectpicker("val");if(!t)return void $("#services-groups, #services").empty().attr("disabled",!0);var s=$.grep(v,function(e){return e.parent_id==t});$("#services-groups").empty().attr("disabled",null).append('<option value="">- ?’N‹?±?µNˆ?? -'),s.forEach(function(e){$('<option value="'+e.id+'">').text(e.title).attr("disabled",e.disabled).appendTo("#services-groups")}),$("#services-groups").trigger("change"),$("#services-groups").selectpicker("refresh")}),$("#services-groups").on("changed.bs.select",function(e){var t=$(this).selectpicker("val");if(t){var s=$.grep(d,function(e){return e.group_id==t});$("#services").empty().attr("disabled",null).append('<option value="">- ?’N‹?±?µNˆ?? -'),s.forEach(function(e){$('<option value="'+e.id+'">').text(e.title).attr("disabled",e.selected).appendTo("#services")})}else $("#services").empty().attr("disabled",!0);$("#services").selectpicker("refresh").prop("disabled",!1),c()}),$("#services").on("changed.bs.select",function(e){var t=$(this).val();$("#add-service-btn").attr("disabled",!t),$("#add-service-form").trigger("submit"),c()}),$("#services-distincts").trigger("change"),$("#add-service-form").submit(function(){var e=parseInt($("#services").val()),t=$("#services option:selected").text();e&&i(e,t)&&(r(e,!0),n(e)),$("#add-service-form").trigger("reset"),$("#services-groups").prop("disabled",!0).attr("disabled",!0).selectpicker("refresh"),$("#services").prop("disabled",!0).attr("disabled",!0).selectpicker("refresh");var o=s().length;return o>0&&($(".choosen-service-block").removeClass("empty-block"),$(".services-not-choosen").hide(),$("#add-service-btn").text("?”???±?°????N‚N? N?N??»N???N? ???»N? N??µ?±N? ???»?? Nˆ????N?N‚???µ?????????°"),$("#add-service-btn").attr("disabled",!0)),!1}),$("#add-service-form label > a").click(function(){return!1}).tooltip(),$(document).on("click",".remove-service-btn",function(){var e=$(this).parent().attr("data-id");o(e)&&r(e,!1),$("#add-service-btn").attr("disabled",!0);var t=s();return 0===t.length&&($("#choose-services-submit").attr("disabled",!0),$(".choosen-service-block").addClass("empty-block"),$(".services-not-choosen").show()),!1}),$("#choose-services-submit").click(function(){var e=$(this),t=s();return $("#add-service-form").trigger("submit"),t=s(),$.post(e.data("submit"),{services:t},function(){window.location=e.data("redirect")}),!1}),$("#delete-all").click(function(){s().forEach(function(e){o(e)}),c()}),$(document).on("click",".recommend-service",function(){var e=$(this).parent().attr("data-service-id"),t=$(this).text();return e&&i(e,t)&&(r(e,!0),n(e),$(".selected-service").popover("destroy"),$(this).remove()),!1}),c()}
function WaitingControl(t,i,e){this.seconds=parseInt(t),this.message_title=i.message_title,this.message_text=i.message_text,this.redirectLink=e,this.showNotification=function(t,i,e){var s="<strong>"+t+"</strong><br />"+i;$.notify(s,{type:"info",allow_dismiss:!1,delay:e})},this.waitAndRedirect=function(){var t=1e3*this.seconds,i=Math.floor(t-t/3),e=this;setTimeout(function(){e.showNotification(e.message_title,e.message_text,i)},Math.floor(i)),setTimeout(function(){window.location.replace(e.redirectLink)},t)}}
function InitChooseTime(){function e(e,r){e&&e.length&&($.each(e,function(e,t){$("#service-"+t+" select[name^=services-time]").attr("disabled",!0)}),App.ajaxCall("get-time",{date:c(e),service_ids:e},function(d){return d.error?(console.log(d.error),void p("?????°?¶?°?µ??N‹?? ???»???µ??N‚","?’N‹?±Nˆ?°???????µ ???°???? ??Nˆ?µ??N? ?·?°??N?N‚??. <br> <strong>?’N‹?±?µNˆ?µN‚?µ ??NˆN??????µ ??Nˆ?µ??N?.</strong>")):($.each(d.services,function(e,t){var r,l,c=$("#service-"+e),m=c.find("select[name^=services-time]"),v=c.find(".duration .value"),p=c.find(".duration .hidden"),h=a(t.time_from,t.time_till),g=[];t.masters&&$.each(t.masters,function(e,t){if(t.group){for(var i in t.master_free_time)g.push(t.master_free_time[i].time_from);g=f(g),g=jQuery.grep(g,function(e){return e!==t.time_till})}else for(var i in t.master_free_time)l=a(t.master_free_time[i].time_from,t.master_free_time[i].time_till),$.each(l,function(e,t){g.push(t.time)});var n=a(t.time_from,t.time_till),c=!1;$.each(n,function(a,i){return!(s(t,i.time)&&o(d.user,i.time)&&u(i.time))||void $.each(h,function(a,n){n.time===i.time&&(n.masters=n.masters||[],n.masters.push({master_id:e,fullname:t.fullname,duration:t.duration,class:t.class,price:t.price,group:t.group,service_remote_id:t.service_remote_id,master_remote_id:t.master_remote_id,date:t.date}),c=!0)})}),c&&(void 0===r||t.duration<r)&&(r=parseInt(t.duration))}),m.prop("disabled",!1),m.empty().removeAttr("disabled"),m.append('<option class="null" value="" selected="selected">- ?’N‹?±?µNˆ?? ??Nˆ?µ??N? -</option>'),$.each(h,function(e,t){$.inArray(t.time,g)!==-1?$("<option>").attr("value",t.time).addClass("active").css("color","green").data("time",t).text(i(t.time)+" [c?????±????????]").appendTo(m):$("<option>").attr("value",t.time).attr("disabled",!0).css("color","darkred").data("time",t).text(i(t.time)+" [?·?°??N?N‚??]").appendTo(m)}),m.selectpicker("refresh"),m.data("duration",r?r:0),m.data("duration_hidden"),v.text(r?n(r):"?"),p.text(r?r:"?"),c.removeClass("no-time").find(".master-class .value, .master .value, .price .value").text("?"),c.removeClass("no-time").find(".group_count, .group_busy").hide(),c.removeClass("no-time").find(".group_count, .group_busy").hide(),c.find(".data > .err").hide()}),e.forEach(function(e){var t=$("#service-"+e+" select[name^=services-time]");d.services[e]||t.empty().append('<option class="null">???µ ???°?????µ???? ???°N?N‚?µNˆ???? (?°?????°Nˆ?°N‚????) ???° '+c())}),"function"==typeof r&&r.apply(this),t(),void $("select[name^=services-time]:first").trigger("change"))}))}function t(){$("select[name^=services-time]").each(function(){var e=$(this),t=e.children("option:not(.null)");t.removeAttr("disabled"),e.children("option:not(.null)").size()&&0!==e.children(".active").size()||(e.empty().attr("disabled",!0).append('<option class="null">???µN‚ N??????±???????????? ??Nˆ?µ???µ????'),e.parents(".service").addClass("no-time"),$("#choose-time-submit").parent().attr("data-original-title","?’N‹?±?µNˆ??N‚?µ ??NˆN???N?NZ ???°N‚N? ???»?? N?N??»N???N?. ???????±???????????? ??Nˆ?µ???µ???? N? ???°N?N‚?µNˆ?° (?°?????°Nˆ?°N‚?°) ???µ N…???°N‚?°?µN‚ ???»N? ??N‹?????»???µ????N? N?N??»N?????.")),e.selectpicker("refresh")})}function a(e,t){for(var a=[],i=15,n=e;n<t;n+=i)a.push({time:n});return a}function i(e){var t="0"+Math.floor(e/60),a="0"+e%60;return t.substr(t.length-2)+":"+a.substr(a.length-2)}function n(e){var t=Math.floor(e/60),a=e%60,i="";return t>0&&(i+=t+" N‡."),(a>0||0==t)&&(i+=a+" ??????."),i.trim()}function r(e,t,a,i){return e<a+i&&a<e+t}function s(e,t){if(e.master_free_time&&e.master_free_time.length)for(var a=0;a<e.master_free_time.length;++a){var i=e.master_free_time[a],n=i.time_till-i.time_from;if(r(i.time_from,n,t,15))return!0}return!1}function o(e,t){if(e&&void 0!==e){var a=!0,i=e.times,n=e.date;return n===c()&&i&&i.forEach(function(e){var i=parseInt(e.time_from),n=parseInt(e.time_till);r(t,15,i,n-i)&&(a=!1)}),a}return!1}function d(e){var t="0"+e.getDate(),a="0"+(e.getMonth()+1);return e.getFullYear()+"-"+a.substr(a.length-2)+"-"+t.substr(t.length-2)}function l(e){var t=e.split("-");return new Date(t[0],parseInt(t[1])-1,t[2])}function c(e){return d($("#datepicker").datepicker("getDate"))}function m(){return $("#services-list .service").size()}function u(e){var t=new Date,a=$("#datepicker").datepicker("getDate");return a.setHours(Math.floor(e/60)),a.setMinutes(e%60),a.getTime()-t.getTime()>6e5}function v(){var e=$("#services-list > .service"),t=!0;e.length>0?e.each(function(){return $("select[name^=services-time]",this).val()&&$("input[name^=master]",this).val()?void $(this).find(".data > .err").hide():(t=!1,!1)}):t=!1,t?$("#choose-time-submit").attr("disabled",!1).parent().tooltip("destroy"):$("#choose-time-submit").attr("disabled",!0).parent().tooltip()}function f(e){var t=[];return $.each(e,function(e,a){$.inArray(a,t)===-1&&t.push(a)}),t}function p(e,t){$("#modalMessage .modal-title").text(e),$("#modalMessage .modal-body").html(t),$("#modalMessage").modal("show")}var h=Math.floor((new Date).getTime()/1e3);$("#add-service-btn").click(function(){$("#time-form, .controls").hide(),$("#add-service-panel").show()}),$("#add-service-form button").click(function(){$("#add-service-panel").hide(),$("#time-form, .controls").show()}),$(document).on("click",".service .popover .popover-content a",function(){var e=$(this),t=e.parents(".service"),a=t.find(".service-master-select"),i=e.data("master-id");e.data("duration");if(i){a.find("option:selected").removeAttr("selected");var r=a.find("option[value="+i+"]");r.attr("selected",!0),t.find("select[name^=services-time]").popover("hide");var s=r.data(),o=t.find("input[name^=master]");t.find("select[name^=services-time] option:selected:not(.null)").size()>=1?(t.find(".data > .master > .value").text(s.fullname),t.find(".data > .master-class > .value").text(s.class),t.find(".data > .price > .value").text(s.price+" NˆN??±."),t.find(".data > .duration > .value").text(n(s.duration)),o.val(i)):(t.find(".data > .master > .value").text("?"),t.find(".data > .master-class > .value").text("?"),t.find(".data > .price > .value").text("?"),o.val(null)),v()}return!1}),$(document).on("change",".service-master-select",function(){var e=$(this),t=e.parents(".service"),a=t.find("input[name^=master]"),i=e.find("option:selected").data();t.find("select[name^=services-time] option:selected:not(.null)").size()?(t.find(".data > .master > .value").text(i.fullname),t.find(".data > .master-class > .value").text(i.class),t.find(".data > .price > .value").text(i.price+" NˆN??±."),a.val(e.val())):(t.find(".data > .master > .value").text("?"),t.find(".data > .master-class > .value").text("?"),t.find(".data > .price > .value").text("?"),a.val(null)),v()}),$(document).on("click",".btn-remove-service",function(){var e=$(this),t=e.parents(".service"),a=t.attr("data-service-id");if(confirm("?’N‹ ???µ??N?N‚????N‚?µ?»N????? N…??N‚??N‚?µ ???”???›?????¬ N?N??»N???N??")){if($(".service").size()>1)return $("#service-"+a).remove(),v(),!0;p("?????°?¶?°?µ??N‹?? ???»???µ??N‚","?”?»N? ??N‹?±??Nˆ?° ??NˆN?????N… N?N??»N??? ???µNˆ????N‚?µN?N? ???° N??°?? ???°?·?°??!")}return!1}),$(document).on("focus","ul.dropdown-menu li",function(){var e=$(this),t=e.parents(".service"),a=t.find("select[name^=services-time]"),i=t.find('select[name^=services-time] option:eq("'+bs_original_index+'")'),n=$("select[name^=services-time]"),r=n.not(a);r.each(function(){var e=$(this);e.find("option:not(.null)").each(function(){var e=$(this);e.attr("data-icon","")})}),a.selectpicker("val",i.val()),a.trigger("change"),$(document).width()>480&&a.selectpicker("show")}),$(document).on("mouseout","ul.dropdown-menu li",function(){var e,t,a=$(this),i=a.parents(".service"),n=(i.find("input[name^=master]"),a.find("option:selected").data(),i.find("select[name^=services-time]")),r=$("select[name^=services-time]"),s=r.not(n),o=$(this).attr("data-original-index"),d=i.find('select[name^=services-time] option:eq("'+o+'")'),l=i.find(".duration .hidden"),c=[],m=i.find(".is_group");if(s.each(function(){var e=$(this);e.find("option:not(.null)").each(function(){var e=$(this);e.attr("data-icon","")})}),"1"===m.text())return!1;if(t=0,l=parseInt(l.text()),$("select[name^=services-time]  > option").each(function(){if($(this).css("background",""),e=parseInt($(this).val()),e>=parseInt(d.val())&&t<=l-15){if(void 0!==c){if(!$('select[name^=services-time] option[value="'+e+'"]').hasClass("active"))return void(c=void 0);c.push(e)}t+=15}}),void 0!==c){var u;$(c).each(function(e,t){e!==c.length&&(u=$('select[name^=services-time] option[value="'+t+'"]',i),u.css("background","#d6edc9"))}),s.each(function(){var e=$(this);e.find("option:not(.null)").each(function(){var e=$(this);$.inArray(parseInt(e.val()),c)>-1&&e.attr("data-icon","glyphicon-lock")})}),d.hasClass("active")&&(n.selectpicker("hide"),$(document).width()>480&&n.selectpicker("show")),n.selectpicker("refresh")}}),$(document).on("change",".service-master-select",function(){$(".service-master-select").show();var e=$(this),t=e.parents(".service"),a=t.find("input[name^=master]"),n=e.find("option:selected").data(),r=(t.find("select[name^=services-time]"),t.find("select[name^=services-time] option:selected:not(.null)"));if(r.size()){if(t.find(".data > .master > .value").text(n.fullname),t.find(".data > .master-class > .value").text(n.class),t.find(".data > .price > .value").text(n.price+" NˆN??±."),n.group){t.find(".data > .group_count").show(),t.find(".data > .group_busy").show(),t.find(".data > .group_count > .value").text(n.group.group_count);var s=i(t.find("select[name^=services-time]").val()),o=n.date+"-"+s;App.ajaxCall("get_service_busy",{service_id:n.service_remote_id,master_id:n.master_remote_id,datetime:o},function(e){t.find(".data > .err").text("").hide(),400==e?t.find(".data > .group_busy > .value").text(0):500==e?(t.find(".data > .err").text("?zN????±???° ?????»N?N‡?µ????N? ???°????N‹N… ?? ??NˆN????????????? ?·?°??N?N‚????, ??????Nˆ???±N???N‚?µ ?????·?¶?µ."),t.find(".data > .err").show(),$("#choose-time-submit").attr("disabled",!0)):e>=n.group.group_count?(t.find(".data > .err").text("???µN‚ N??????±??????N‹N… ???µN?N‚ ???»N? ?·?°????N???. ?’N‹?±?µNˆ?µN‚?µ ??NˆN??????µ ??Nˆ?µ??N?."),t.find(".data > .err").show(),$("#choose-time-submit").attr("disabled",!0),t.find(".data > .group_busy > .value").text(n.group.group_count)):t.find(".data > .group_busy > .value").text(e)})}a.val(e.val())}else t.find(".data > .master > .value").text("?"),t.find(".data > .master-class > .value").text("?"),t.find(".data > .price > .value").text("?"),a.val(null);v()}),App.ajaxCall("get_date_schedule",{},function(t){$(".preloader-block").hide(),$(".datepicker-block").show(),$("#datepicker").attr("data-dates-available",JSON.stringify(t));var a=$("#datepicker").data("dates-available");$("#datepicker").datepicker({language:"ru",format:"dd/mm/yyyy",startDate:new Date,weekStart:1,todayHighlight:!0,toggleActive:!1,beforeShowDay:function(e){return e=d(e),a&&a[e]===!0}}).on("changeDate",function(t){var a=Math.floor(t.timeStamp/1e3);$("#date").val(c());var i=$(".service").map(function(){return $(this).data("service-id")}).get();e(i,function(){var e="#service-"+i[0],t=e+" .bootstrap-select";$(t).removeClass("open"),a-h>1&&setTimeout(function(){$(e+" #select-time").children(".active").length>0&&$(document).width()>480&&($(t).select("open"),$(".dropdown-toggle[data-id=select-time]")[0].click())},400),$("select[name^=services-time]").each(function(){var e=$(this);e.data("time")&&e.find("option").each(function(){var t=$(this),a=t.data("time");if(a&&a.from+"-"+a.till===e.data("time"))return t.attr("selected",!0),e.trigger("change"),!1})})})});var i;for(var n in a)if(a[n]){var r=l(n);(!i||i>r)&&(i=r)}i&&$("#datepicker").datepicker("setDate",i),0===m()&&$("#add-service-btn").trigger("click"),$("#choose-time-submit").on("click",function(){var e=$(this),t=$("#time-form").serialize();return!e.attr("disabled")&&(e.attr("disabled",!0),$.post(e.data("submit"),t,function(t){"ok"===t?window.location=e.attr("href"):(console.log(t),p("?????°?¶?°?µ??N‹?? ???»???µ??N‚","<strong>?’N‹ ???µ ?????¶?µN‚?µ ?·?°????N??°N‚N?N?N? ???° N?N??»N???N? ???? ?????????? ???· N??»?µ??N?NZN‰??N… ??Nˆ??N‡????:</strong><br>1. ?’N‹?±Nˆ?°?????°N? ?’?°???? N?N??»N????° ?·?°???????°?µN‚ ?±???»N?N??µ ??Nˆ?µ???µ???? N‡?µ?? ?µN?N‚N? N? ???°N?N‚?µNˆ?°.<br>2. ?’N‹?±Nˆ?°????N‹?? ?’?°???? ?°?????°Nˆ?°N‚ ?·?°??N?N‚ ??NˆN??????? N????µN†???°?»??N?N‚????.<br>3. ?’N??µ ???°?±?????µN‚N‹ ???»N? ??Nˆ?????µ???µ????N? ???°???????? N?N??»N????? ?·?°??N?N‚N‹."),e.attr("disabled",!1))}),!1)}),$("select[name^=services-time]").selectTime(),$("[data-toggle=tooltip]").tooltip(),v()}),jQuery.fn.extend({selectTime:function(){function e(e){return e.fullname+" "+n(e.duration)}var a=$(this);a.popover({trigger:"manual",title:"?’N‹?±?µNˆ?? ???°N?N‚?µNˆ?°",html:!0,content:function(){var e=$(this),t=e.find("option:selected"),a=t.data("time").masters;if(a){var i=$('<ul class="masters-popover">');return $.each(a,function(e,t){$('<a href="#">').attr("data-master-id",t.master_id).attr("data-duration",t.duration).append('<span class="name">'+t.fullname).append('<span class="class">'+t.class).append('<span class="duration">'+n(t.duration)).append('<span class="price">'+t.price+" NˆN??±.").appendTo("<li>").parent().appendTo(i)}),i=i.wrap("<div>").parent(),i.html()}}}).change(function(){var t=$(this),a=t.parents(".service"),i=a.find(".service-master"),r=t.find("option:selected"),s=r.data("time");if(r.hasClass("null"))return void a.find(".service-master-select").addClass("hidden");if(s&&s.masters){var o=a.find(".service-master-select"),d=a.find("input[name^=master]"),l=null,c=Object.keys(s.masters).length;if($.each(s.masters,function(e,t){if(t.master_id===d.val())return l=t,!1}),c>1)t.popover("show"),$(".popover").css("top","-90px").css("left","370px"),o.empty().removeClass("hidden"),$.each(s.masters,function(t,a){$('<option value="'+a.master_id+'">').data(a).text(e(a)).attr("selected",!l||l===a).appendTo(o),l||(l=a)}),i.addClass("hidden-xs");else if(t.popover("hide"),o.empty().addClass("hidden"),i.removeClass("hidden-xs"),1===s.masters.length){var m=s.masters[0];$('<option value="'+m.master_id+'">').data(m).text(e(m)).attr("selected",!0).appendTo(o),l=m}var u=a.find(".duration .value"),f=a.find(".duration .hidden");l?(console.log(l),i.text(e(l)),d.val(l.master_id),u.text(n(l.duration)),f.text(l.duration),o.data("duration",parseInt(l.duration)),o.data("duration_hidden",parseInt(l.duration)),t.data("duration",parseInt(l.duration))):(i.text("???µN‚ ???°N?N‚?µNˆ???? ???° N?N‚?? ??Nˆ?µ??N?!"),d.val(""),u.text("?"),o.data("duration",null)),a.find(".service-master-select").trigger("change"),v()}else p("?????°?¶?°?µ??N‹?? ???»???µ??N‚","<strong>?’N‹ ???µ ?????¶?µN‚?µ ?·?°????N??°N‚N?N?N? ???° N?N??»N???N? ???? ?????????? ???· N??»?µ??N?NZN‰??N… ??Nˆ??N‡????:</strong><br>1. ?’N‹?±Nˆ?°?????°N? ?’?°???? N?N??»N????° ?·?°???????°?µN‚ ?±???»N?N??µ ??Nˆ?µ???µ???? N‡?µ?? ?µN?N‚N? N? ???°N?N‚?µNˆ?°.<br>2. ?’N‹?±Nˆ?°????N‹?? ?’?°???? ?°?????°Nˆ?°N‚ ?·?°??N?N‚ ??NˆN??????? N????µN†???°?»??N?N‚????.<br>3. ?’N??µ ???°?±?????µN‚N‹ ???»N? ??Nˆ?????µ???µ????N? ???°???????? N?N??»N????? ?·?°??N?N‚N‹.<br>4. ?’???·?????¶???? N? ???°N? N??¶?µ ?????µNZN‚N?N? ?·?°????N??? ???° ??N‹?±Nˆ?°???????µ ??Nˆ?µ??N?"),a.find(".data > .err").show(),$("#choose-time-submit").attr("disabled",!0)});var i=function(){var e=$(this),t=e.data("duration")||15,a=$("select[name^=services-time]"),i=a.not(e),n=e.find("option:selected"),s=n.data("time");s&&i.each(function(){var e=$(this),a=e.data("duration")||15;e.find("option:not(.null)").each(function(){var i=$(this),n=i.data("time");r(s.time,t,n.time,a)&&(i.attr("disabled",!0),i.attr("data-icon",""),i.is(":selected")&&(i.removeAttr("selected"),e.find("option.null").attr("selected",!0)))})})};a.parents(".service").find(".service-master-select").change(function(){t(),$("select[name^=services-time]").each(i),v()})}});var g;$(document).on("click",".writeClientFact",function(){g=$(this).parents(".service"),$("#clientFactModal").modal("show")}),$(document).on("click",".client-fact-save",function(){var e=$("#clientFactModal input[name^=info]"),t=e.val();""!==t&&t.length>3?(g.find(".data > .info .title").text("?s?»???µ??N‚:"),g.find(".data > .info .writeClientFact").html('<span class="glyphicon glyphicon-edit"/>'),g.find(".data > .info .value").text(e.val()),g.find(".data > .info #info").val(e.val())):(g.find(".data > .info .writeClientFact").text("?—?°????N??°N‚N? ??NˆN????° ???»?? Nˆ????N?N‚???µ?????????°"),g.find(".data > .info .title").text(""),g.find(".data > .info .value").text("")),$("#clientFactModal").modal("hide")}),$(function(){var e,t=540,n=1320,r=$("input[name=wldate]"),s=$("select[name=hour_from]"),o=$("select[name=hour_till]"),d=$("input[name=client_phone]"),l=$("input[name=client_id]"),m=($("#formWaitingList"),function(e){var t=/((8|\+7)-?)?\(?\d{3}\)?-?\d{1}-?\d{1}-?\d{1}-?\d{1}-?\d{1}-?\d{1}-?\d{1}/;return!!e.match(t)}),u=function(e,t,a,i,n,r){return App.ajaxCall("add_waiting_list",{service_id:e,datetime_from:t,datetime_till:a,client_phone:i,master_id:n,client_id:r},function(e){if(null!==e||"500"!==e)return!1}),!0};$(".openModalWaitingList").click(function(){var l=[];e=$(this).parents(".service"),$("#modalWaitingList").modal("show"),$("#modalWaitingList #date").val(c()),r.parent().removeClass("has-error"),s.val("").parent().removeClass("has-error"),o.val("").parent().removeClass("has-error"),d.parent().removeClass("has-error");var m=e.find(".favorite-master");m.length>0?($("select[name=favorite_master] option").remove(),m.children(".fav-master").each(function(e,t){$("select[name=favorite_master]").append(new Option($(t).children().text(),$(t).data("id")))}),$("select[name=favorite_master]").append(new Option("???µ ?????µ?µN‚ ?·???°N‡?µ????N?",""))):($("select[name=favorite_master] option").remove(),$("select[name=favorite_master]").hide().parent().hide(),$("select[name=favorite_master]").append(new Option("???µ ?????µ?µN‚ ?·???°N‡?µ????N?","")),$("select[name=favorite_master] [value='']").attr("selected","selected")),$("#wlAlertErr").hide(),$("#wlAlertSuccess").hide(),l=a(t,n),l.forEach(function(e,t){s.append(new Option(i(e.time),e.time)),o.append(new Option(i(e.time),e.time))})}),$("select[name=hour_from]").change(function(){var e=parseInt($("select[name=hour_from]").val()),t=[];t=a(e,n),$("select[name=hour_till]").empty(),o.append(new Option("?Y??","")),t.forEach(function(e,t){o.append(new Option(i(e.time),e.time))})}),$("#btnWaitingListSend").click(function(){$("#wlAlertSuccess").hide();var t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),i=new Date(r.val());if(i>=a)if(r.parent().removeClass("has-error"),""!==s.val()&&""!==o.val()&&parseInt(s.val())<=parseInt(o.val()))if(s.parent().removeClass("has-error"),o.parent().removeClass("has-error"),m(d.val())){d.parent().removeClass("has-error");var n=$("select[name=hour_from] option:selected").text(),c=$("select[name=hour_till] option:selected").text(),v=r.val()+"-"+n+":00",f=r.val()+"-"+c+":00",p="8"+d.val(),h=e.find("input[name=service_remote_id]").val(),g=$("select[name=favorite_master]").val(),_=u(h,v,f,p,g,l.val());_?$("#wlAlertSuccess").show():$("#wlAlertErr").show()}else d.parent().addClass("has-error");else s.parent().addClass("has-error"),o.parent().addClass("has-error");else r.parent().addClass("has-error")})})}
$(document).ready(function(){var e={rangeList:{"0912":{time_from:540,time_till:720},1215:{time_from:720,time_till:900},1518:{time_from:900,time_till:1080},1822:{time_from:1080,time_till:1320}},IsRangeValid:function(e){return"all"===e||"0912"===e||"1215"===e||"1518"===e||"1822"===e},GetRangeTimes:function(){return this.rangeList[this.rangeFilter]},GetFilterTime:function(){App.ajaxCall("filter_date_schedule",{range_filter:this.rangeFilter},function(e){if("err"==e.response)console.log(e);else{var t=[];for(var i in e.date_schedule)if(e.date_schedule[i]===!1){var r=new Date(Date.parse(i)),a=r.getDate()+"-"+parseInt(r.getMonth()+1)+"-"+r.getFullYear();t.push(a)}$("#datepicker").datepicker("setDatesDisabled",t)}$(".datepicker-days").show(),$(".preloader-block").hide()})},FilterDates:function(e){this.IsRangeValid(e)&&(this.rangeFilter=e,this.GetFilterTime())}};$(".free-time-select").on("change",function(){var t=$(this),i=t.find("option:selected").val();""!==i&&($(".datepicker-days").hide(),$(".preloader-block").show(),e.FilterDates(i))})});
var Compliments={modalElement:$("#modalComplimentChoose"),choosenCompliment:$("input[name=choosen_compliment_id]"),SetModalToDefaultState:function(){this.modalElement.find(".error").hide(),this.modalElement.find("form.compliments").show(),this.modalElement.find(".btn-choose-compliment").hide(),$(".choose-complement").find("option").remove(),$(".choose-complement").append($('<option value="">?—?°??NˆN??·???° ?????????»?????µ??N‚????..</option>'))},ModalShowError:function(e,o){this.modalElement.find(".error").show().text(e),this.modalElement.find(".btn-choose-compliment").hide(),o&&this.modalElement.find("form.compliments").hide()},GetComplimentsAndSetupUIChoose:function(e){App.ajaxCall("get_compliments",{service_ids:e},function(e){var o=e.ComplimentsOfService,i=o.Compliments;return i.hasOwnProperty("Compliment")?void Compliments.SetComplimentsInSelect(i.Compliment):void Compliments.ModalShowError("?”?»N? N?N‚???? N?N??»N????? ???µN‚ ????N?N‚N?????N‹N… ?????????»?????µ??N‚???? ???»N? ??N‹?±??Nˆ?°!",!0)})},SetComplimentsInSelect:function(e){var o=this.modalElement.find("form.compliments"),i=o.find("select.choose-complement");i.find("option").remove(),i.append($('<option value="">?’N‹?±Nˆ?°N‚N? ?????????»?????µ??N‚</option>')),e.forEach(function(e){var o='<option value="'+e.service_id+'" data-info="'+e.info+'">'+e.title+"</option>";i.append($(o))})},SetSelectedComplimentInServiceList:function(){var e=Compliments.modalElement.find("form.compliments"),o=e.find("select.choose-complement :selected"),i='<li class="selected-compliment"><h4 class="when"></h4><div class="photo"><img src="/images/podarok1.png" /></div><div class="info"><h5 class="service-title">'+o.text()+"</h5><p>"+o.data("info")+'</p><b>?¦?µ???°: <span class="value">?±?µN????»?°N‚????</span></b><br><a href="#" class="delete-selected-compliment link color-gold">?????°?»??N‚N? ?? ??N‹?±Nˆ?°N‚N? ??NˆN???????</a></div><input type="hidden" name="selected_compliment_id" value="'+o.val()+'"<br/></li>';$(".review-services-list").append(i)},RemoveSelectedComplimentFromUI:function(){$(".selected-compliment").remove()},SetSelectedCompliment:function(){var e=this.modalElement.find("form.compliments"),o=e.find("select.choose-complement :selected"),i={compliment_id:o.val(),compliment_title:o.text(),compliment_info:o.data("info")};App.ajaxCall("set_compliment",i,function(e){return e.response&&1===e.response?void Compliments.SetSelectedComplimentInServiceList():void $.notify("?zN????±???° N???N…Nˆ?°???µ????N? ???°N??µ???? ?????????»?????µ??N‚?°, ?????¶?°?»N???N?N‚?°, ??????Nˆ???±N???N‚?µ ?µN‰?µ Nˆ?°?·!",{type:"danger",allow_dismiss:!0,delay:1e5})})},DeleteComplimentIdFromSession:function(){App.ajaxCall("delete_compliment_id",{},function(e){if(!e.response||1!==e.response)return void $.notify("???µN‚N? ???µ????N?N‚N??????°. ?Y????Nˆ???±N???N‚?µ ?µN‰?µ Nˆ?°?·.",{type:"danger",allow_dismiss:!0,delay:1e5})})},AllowConfirmation:function(){$("#review-logged-in-confirm").removeClass("disabled"),$(".btn-confirm-hint").hide(),$("#review-confirm").removeClass("disabled")},DisallowConfirmation:function(){$("#review-logged-in-confirm").addClass("disabled"),$(".btn-confirm-hint").show(),$("#review-confirm").addClass("disabled")}};
$(".activate-compliments-modal").on("click",function(){var e=$(this),t=e.parent(),o=t.parent().find(".info"),m=o.find(".service-title").text(),i=t.parent().find("input[name=service_remote_id]").val();Compliments.SetModalToDefaultState(),Compliments.modalElement.find(".service-title").text(m),Compliments.GetComplimentsAndSetupUIChoose([i])}),$(".choose-complement").on("change",function(){var e=$(this);return""===e.val()?void Compliments.modalElement.find(".btn-choose-compliment").hide():void Compliments.modalElement.find(".btn-choose-compliment").show()}),$(".btn-choose-compliment").on("click",function(){Compliments.SetSelectedCompliment(),Compliments.modalElement.modal("hide"),$(".activate-compliments-modal").hide(),Compliments.AllowConfirmation()}),$(".review-services-list").on("click",".delete-selected-compliment",function(){Compliments.DeleteComplimentIdFromSession(),Compliments.RemoveSelectedComplimentFromUI(),$(".activate-compliments-modal").show(),Compliments.DisallowConfirmation()});